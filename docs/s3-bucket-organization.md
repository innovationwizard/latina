# S3 Bucket Organization Strategy

This document describes how files are organized across the 5 S3 buckets used by the Latina Operations Platform.

## Bucket Overview

All buckets are located in **US East (Ohio) us-east-2** region.

| Bucket Name | Purpose | Structure |
|------------|---------|-----------|
| `latina-uploads` | Original file uploads before processing | `uploads/{projectId}/originals/{timestamp}-{filename}` |
| `latina-images` | General project images (photos, workflow images) | `projects/{projectId}/{workflowStep}/images/{timestamp}-{filename}` |
| `latina-leonardo-images` | Leonardo AI enhanced/rendered images | `enhanced/{projectId}/{timestamp}-{filename}` |
| `latina-designs` | Design files (CAD, renders, presentations) | `projects/{projectId}/{workflowStep}/designs/{timestamp}-{filename}` |
| `latina-not-images` | Non-image documents (PDFs, spreadsheets, etc.) | `projects/{projectId}/{workflowStep}/documents/{timestamp}-{filename}` |

## Detailed Bucket Usage

### 1. latina-uploads
**Purpose:** Temporary storage for original file uploads before they are categorized and moved to appropriate buckets.

**Use Cases:**
- Initial file uploads from users
- Files uploaded through the enhance API before processing
- Backup of original uploads

**Structure:**
```
uploads/
  {projectId}/
    originals/
      {timestamp}-{filename}
```

**Example:**
```
uploads/abc123-def456/originals/1704067200000-photo.jpg
```

---

### 2. latina-images
**Purpose:** General project images that are not AI-enhanced.

**Use Cases:**
- Site visit photos
- Workflow step photos
- General project imagery
- Photos uploaded in workflow steps

**Structure:**
```
projects/
  {projectId}/
    {workflowStep}/
      images/
        {timestamp}-{filename}
```

**Example:**
```
projects/abc123-def456/site_visit/images/1704067200000-site-photo.jpg
```

---

### 3. latina-leonardo-images
**Purpose:** AI-enhanced images generated by Leonardo AI.

**Use Cases:**
- Enhanced images from the `/api/enhance` endpoint
- Final rendered images
- AI-processed proposal images

**Structure:**
```
enhanced/
  {projectId}/
    {timestamp}-{filename}
```

**Example:**
```
enhanced/abc123-def456/1704067200000-enhanced.jpg
```

---

### 4. latina-designs
**Purpose:** Design files and technical drawings.

**Use Cases:**
- CAD files (.dwg, .dxf)
- 3D model files (.skp, .3dm, .rhino, .blend, .max, .fbx)
- Design software files (.ai, .eps, .psd)
- Render outputs
- Technical drawings
- Presentations

**File Types Detected:**
- Drawing files: `.dwg`, `.dxf`
- 3D models: `.skp`, `.3dm`, `.rhino`, `.blend`, `.max`, `.fbx`
- Design files: `.ai`, `.eps`, `.psd`
- Or files with descriptions containing: "design", "drawing", "render", "technical", "presentation"

**Structure:**
```
projects/
  {projectId}/
    {workflowStep}/
      designs/
        {timestamp}-{filename}
```

**Example:**
```
projects/abc123-def456/technical_drawings/designs/1704067200000-plan.dwg
```

---

### 5. latina-not-images
**Purpose:** Non-image documents and files.

**Use Cases:**
- PDF documents
- Word documents (.doc, .docx)
- Excel spreadsheets (.xls, .xlsx)
- Contracts
- Specifications
- Other non-image, non-design files

**Structure:**
```
projects/
  {projectId}/
    {workflowStep}/
      documents/
        {timestamp}-{filename}
```

**Example:**
```
projects/abc123-def456/quotation/documents/1704067200000-quote.pdf
```

## Implementation

The bucket organization is handled centrally in `lib/s3-utils.ts`:

- `getS3Config()` - Determines the appropriate bucket and key path based on file type and context
- `determineFileCategory()` - Categorizes files based on MIME type and metadata
- `getS3Url()` - Generates public S3 URLs

### File Category Types

```typescript
type FileCategory = 
  | 'original_upload'      // Original file upload (before processing)
  | 'leonardo_enhanced'    // Leonardo AI enhanced image
  | 'project_image'        // General project image (site visit, workflow photo)
  | 'design_file'         // Design file (drawing, render, presentation, technical)
  | 'document';           // Non-image document (PDF, doc, etc.)
```

## Environment Variables

The following environment variables can be used to override default bucket names:

```env
S3_UPLOAD_BUCKET=latina-uploads
S3_IMAGES_BUCKET=latina-images
LEONARDO_S3_BUCKET=latina-leonardo-images
S3_DESIGNS_BUCKET=latina-designs
S3_NOT_IMAGES_BUCKET=latina-not-images
AWS_REGION=us-east-2
```

## Benefits of This Organization

1. **Clear Separation:** Each bucket has a specific purpose, making it easy to find files
2. **Scalability:** Organized by project and workflow step for easy navigation
3. **Cost Management:** Can apply different lifecycle policies per bucket
4. **Security:** Can set different access policies per bucket type
5. **Maintainability:** Centralized logic makes it easy to update organization rules

## Migration Notes

If you have existing files in buckets, they will continue to work. New uploads will follow the new organization structure. Consider migrating old files to the new structure during maintenance windows.

